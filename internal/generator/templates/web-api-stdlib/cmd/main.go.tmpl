package main

import (
    "context"
    "log"
    "net/http"
    "os"
    "os/signal"
    "syscall"

    "{{.ModuleName}}/handlers"
    "{{.ModuleName}}/middleware"
    "{{.ModuleName}}/utils"
)

func main() {
    // Load configuration
    port := os.Getenv("PORT")
    if port == "" {
        port = utils.DefaultPort
    }

    // Create router
    mux := http.NewServeMux()

    // Register routes
    mux.HandleFunc("/health", handlers.HealthHandler)
    mux.HandleFunc("/api/v1/ping", handlers.PingHandler)

    
    // Apply middleware chain
    handler := middleware.ApplyMiddleware(mux)

    // Setup server with timeouts
    server := &http.Server{
        Addr:         ":" + port,
        Handler:      handler,
        ReadTimeout:  utils.ServerReadTimeout,
        WriteTimeout: utils.ServerWriteTimeout,
        IdleTimeout:  utils.ServerIdleTimeout,
    }

    // Start server with graceful shutdown
    startServer(server, port)
}

func startServer(server *http.Server, port string) {
    // Channel to listen for errors
    serverErrors := make(chan error, 1)

    // Start server in goroutine
    go func() {
        log.Printf("Server starting on :%s", port)
        if err := server.ListenAndServe(); err != nil && err != http.ErrServerClosed {
            serverErrors <- err
        }
    }()

    // Channel to listen for interrupt signals
    shutdown := make(chan os.Signal, 1)
    signal.Notify(shutdown, syscall.SIGINT, syscall.SIGTERM)

    // Wait for either error or shutdown signal
    select {
    case err := <-serverErrors:
        log.Fatalf("Server failed to start: %v", err)
    case sig := <-shutdown:
        log.Printf("Received signal %v, shutting down server...", sig)

        // Create shutdown context with timeout
        ctx, cancel := context.WithTimeout(context.Background(), utils.ShutdownTimeout)
        defer cancel()

        // Attempt graceful shutdown
        if err := server.Shutdown(ctx); err != nil {
            log.Printf("Server forced to shutdown: %v", err)
        } else {
            log.Printf("Server stopped gracefully")
        }
    }
}
